name: Compile
on: [push]
# on: 
#   pull_request: {}
#   push:
#     branches:
#       - main
#   release:
#     types: [published]
jobs:

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.3

    - name: Get CMake
      uses: lukka/get-cmake@latest

    - name: Download libsndfile
      run: |
        cd thirdparty
        curl -OL https://github.com/libsndfile/libsndfile/releases/download/1.0.31/libsndfile-1.0.31-win64.zip
        tar -xf libsndfile-1.0.31-win64.zip
        ls -r ${{ github.workspace }}/thirdparty/libsndfile-1.0.31-win64/*

    - name: Build LLVM
      run: |
        cd thirdparty/llvm-project/llvm
        cmake -Bbuild -DLLVM_USE_CRT_DEBUG=MDd -DLLVM_USE_CRT_RELEASE=MD -DLLVM_BUILD_TESTS=Off -DCMAKE_INSTALL_PREFIX="./llvm" -Thost=x64`
        msbuild build/LLVM.sln /property:Configuration=Release
    
    - name: Build TD-Faust (Release)
      run: |
        cmake -Bbuild -DUSE_LLVM_CONFIG=off -DSndFile_DIR=${{ github.workspace }}/thirdparty/libsndfile-1.0.31-win64/cmake
        msbuild build/TD-Faust.sln /property:Configuration=Release
      env:
        LLVM_DIR: ${{ github.workspace }}/thirdparty/llvm-project/llvm/build/lib/cmake/llvm

    - name: Upload Release to Github
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ${{ github.workspace }}/Plugins/TD-Faust.dll
          ${{ github.workspace }}/Plugins/faust.dll

  build-macos:
    strategy:
      matrix:
        name: [macos-cmake]
        include:
          - name: macos-cmake
            os: macos-latest
            cc: clang
            cxx: clang++
            build-system: cmake
            cmake-generator: 'Unix Makefiles'
            cmake-options: >-
              -DCMAKE_BUILD_TYPE=Release
              -DCMAKE_VERBOSE_MAKEFILE=ON
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: download LLVM
      run: |
        cd thirdparty
        curl -OL https://github.com/llvm/llvm-project/releases/download/llvmorg-12.0.0/clang+llvm-12.0.0-x86_64-apple-darwin.tar.xz
        tar -xf clang+llvm-12.0.0-x86_64-apple-darwin.tar.xz
        ls -r ${{ github.workspace }}/thirdparty/clang+llvm-12.0.0-x86_64-apple-darwin/lib/cmake/llvm/*

    - name: Build libsndfile
      run: |
        brew install autoconf autogen automake flac libogg libtool libvorbis opus mpg123 pkg-config speex
        mkdir thirdparty/libsndfile/build
        cd thirdparty/libsndfile/build
        cmake .. -G "${{matrix.cmake-generator}}" ${{matrix.cmake-options}}
        cmake --build . --config Release
    - name: Use CMake for TD-Faust
      run: |
        cmake -Bbuild -DUSE_LLVM_CONFIG=off -G "Xcode" -DCMAKE_PREFIX_PATH=${{ github.workspace }}/thirdparty/clang+llvm-12.0.0-x86_64-apple-darwin/lib/cmake/llvm -DSndFile_DIR=${{ github.workspace }}/thirdparty/libsndfile/build
        cmake -Bbuild -DUSE_LLVM_CONFIG=off -G "Xcode" -DCMAKE_PREFIX_PATH=${{ github.workspace }}/thirdparty/clang+llvm-12.0.0-x86_64-apple-darwin/lib/cmake/llvm -DSndFile_DIR=${{ github.workspace }}/thirdparty/libsndfile/build
    - name: Build TD-Faust (Release)
      run: |
        xcodebuild -configuration Release -project build/TD-Faust.xcodeproj/
        ls -r *
        mv Release/TD-Faust.bundle Release/TD-Faust.plugin
        cd ${{ github.workspace }}/thirdparty/faust/build/lib/Release
        ls -r *
        mv libfaust.2.38.7.dylib libfaust.2.dylib

    - name: Upload Release to Github
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ${{ github.workspace }}/thirdparty/faust/build/lib/Release/*.dylib
          ${{ github.workspace }}/Release/*.plugin